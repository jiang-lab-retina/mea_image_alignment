# Implementation Plan: NSEW Image Stitcher

**Branch**: `001-nsew-image-stitcher` | **Date**: 2025-11-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-nsew-image-stitcher/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build a GUI application for visualizing and stitching Multi-Electrode Array (MEA) microscopy images based on spatial quadrant positions (N/S/E/W). The system will automatically detect spatial keywords in filenames, display 1-4 images in a 2x2 quadrant layout, and perform automated stitching with quality validation. Key capabilities include handling multiple file formats (.czi, .lsm, .tif/.tiff), dimension normalization, memory-efficient processing of large images, and comprehensive reproducibility through parameter tracking.

**Technical approach**: Python-based desktop application using a mature GUI framework (PyQt5/PyQt6 or tkinter) for cross-platform compatibility. Core image processing leverages NumPy for array operations and specialized libraries for microscopy format parsing (czifile, tifffile). Stitching algorithms implemented using OpenCV's stitching module with custom extensions for missing quadrant interpolation. All processing functions designed as modular library code callable independently of GUI.

## Technical Context

**Language/Version**: Python 3.10+  
**Primary Dependencies**: PyQt6 (GUI), NumPy (array operations), OpenCV (stitching), czifile (CZI format), tifffile (TIFF/LSM formats), Pillow (image I/O)  
**Storage**: Local filesystem for input files and output results; JSON for configuration persistence  
**Testing**: pytest (unit tests), pytest-qt (GUI testing), validation with real MEA data  
**Target Platform**: Desktop (Windows, macOS, Linux) - cross-platform GUI application  
**Project Type**: Single desktop application  
**Performance Goals**: Load 4x(2000x2000px, 16-bit) images in <15 sec; stitch in <60 sec; handle up to 4000x4000px per quadrant with <4GB RAM  
**Constraints**: Read-only file access (data integrity); <2 second UI response time; progress feedback for operations >2 seconds; downsampling for display when output exceeds 4GB  
**Scale/Scope**: Single-user desktop application; typical workload 1-4 images per session; file sizes 50MB-500MB per image; stitched output up to 16GB

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify alignment with Image MEA Dulce Constitution v1.0.0:

- [x] **Data Integrity**: Design preserves original raw data through read-only file access. All transformations documented via JSON manifests. No in-place modifications; all operations on memory copies.
- [x] **GUI Design**: Parameters accessible via labeled sliders/dropdowns with tooltips. File picker for intuitive file selection. Quadrant assignment dialog for ambiguous cases. Visual indicators for empty positions.
- [x] **Reproducibility**: All processing parameters serialized to JSON (blend mode, overlap threshold, alignment method, resize details, source files, timestamps). Load/save configuration support planned.
- [x] **Validation**: Stitching quality metrics (alignment confidence, overlap %) displayed post-processing. Error detection for insufficient overlap. Visual inspection via result window.
- [x] **Modularity**: Core stitching logic in standalone library functions (src/lib/stitching.py, src/lib/io.py). GUI (src/gui/) calls library without embedded logic. CLI planned for future phase.
- [x] **Performance**: Chunked/streaming I/O for large files. Background threading for stitching. Progress indicators for all long operations. Automatic downsampling for >4GB outputs.
- [x] **Testing**: Unit tests for file parsing, keyword detection, stitching core. Integration tests for GUI workflows. Validation with real .czi/.lsm/.tif data from specs/001-nsew-image-stitcher/test-data/.
- [x] **Documentation**: Parameter tooltips explain scientific meaning (blend modes, overlap thresholds). Quickstart guide with example workflow. Architecture diagram in docs/.

**Complexity Justification**: None required - design fully compliant with all constitution principles.

## Project Structure

### Documentation (this feature)

```text
specs/001-nsew-image-stitcher/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   ├── library-api.md   # Core library function contracts
│   └── gui-components.md # GUI component specifications
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── models/
│   ├── __init__.py
│   ├── quadrant_image.py      # QuadrantImage entity
│   ├── stitching_config.py    # StitchingConfig entity
│   └── stitched_result.py     # StitchedResult entity
├── lib/
│   ├── __init__.py
│   ├── io.py                   # File I/O for .czi, .lsm, .tif
│   ├── keyword_detector.py     # NSEW keyword extraction from filenames
│   ├── stitching.py            # Core stitching algorithms
│   ├── dimension_handler.py    # Dimension normalization and resizing
│   └── config_manager.py       # JSON configuration save/load
├── gui/
│   ├── __init__.py
│   ├── main_window.py          # Main application window with 2x2 quadrant layout
│   ├── quadrant_viewer.py      # Individual quadrant image viewer widget
│   ├── stitch_dialog.py        # Stitching parameters configuration dialog
│   ├── assignment_dialog.py    # Manual quadrant position assignment dialog
│   └── result_window.py        # Stitched result display window
└── cli/
    ├── __init__.py
    └── main.py                 # CLI entry point (future phase)

tests/
├── unit/
│   ├── test_io.py
│   ├── test_keyword_detector.py
│   ├── test_stitching.py
│   ├── test_dimension_handler.py
│   └── test_config_manager.py
├── integration/
│   ├── test_gui_workflow.py
│   └── test_end_to_end.py
└── fixtures/
    └── sample_images/          # Small test images for CI

data/
└── test-data/                  # Real MEA microscopy images (not in git, .gitignore)
    ├── README.md               # Instructions to obtain test data
    └── sample-set-001/         # Example quadrant set

docs/
├── architecture.md             # System architecture diagram
└── parameters.md               # Scientific explanation of stitching parameters

requirements.txt                # Python dependencies
setup.py                        # Package installation script
main.py                         # Application entry point
README.md                       # Installation and quick start
.gitignore                      # Exclude test data, .pyc, __pycache__
```

**Structure Decision**: Single desktop application structure selected. This is a standalone GUI tool running on researcher workstations, not a web or mobile app. The structure separates concerns clearly:
- `src/models/` - Data entities (QuadrantImage, StitchingConfig, StitchedResult)
- `src/lib/` - Core processing logic (file I/O, stitching, dimension handling) - framework-agnostic
- `src/gui/` - PyQt6-based UI components
- `src/cli/` - Future command-line interface for batch processing
- `tests/` - Comprehensive test suite with unit and integration tests
- `data/test-data/` - Real microscopy images for validation (excluded from git due to size)

This structure adheres to constitution Principle V (Modular Architecture) by keeping processing logic (`lib/`) completely independent of GUI (`gui/`), enabling programmatic access and future CLI development.

## Complexity Tracking

> **No violations - section not applicable**

All constitution principles satisfied without requiring complexity justifications.
